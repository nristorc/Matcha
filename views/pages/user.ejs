<%- include('../partial/head')%>
<%- include('../partial/header')%>

<%- messages('partial/message', locals) %>

<div class="media">
    <img src="/<%=user[0]['profil']%>" alt="profilPic" class="float-left profile-pic" height="220px" width="220px" id="avatarPic">
    <div class="media-body">
        <div style="display: flex" id="likeAndMatch">
            <button type="button" class="btn btn-primary popularity">
                Popularité <span class="badge badge-light"><%=user[0]['popularity']%>%</span>
            </button>

            <%var found1 = 0%>
            <%var found2 = 0%>
            <%var found3 = 0%>
            <%var found4 = 0%>
            <%var found5 = 0%>
            <%if (likes !== null) {%>
                <% for (var x = 0; x < likes.length; x++)  {%>
                    <% if (likes[x].user_liked === user[0].id) {%>
                        <%found1 = 1;%>
                <%}}%>
                <%if (found1 === 1) {%>
                    <span><i class="fas fa-thumbs-up" style="color: dodgerblue; font-size: xx-large; margin-left: 10px" onclick="iUnlike(<%=user[0].id%>)"></i></span>
                <%} else if(found1 === 0) {%>
                    <span><i class="far fa-thumbs-up" style="font-size: xx-large; margin-left: 10px" onclick="iLike(<%=user[0].id%>)"></i></span>
            <%}}%>

            <%if (matches !== null) {%>
                <% for (var y = 0; y < matches.length; y++)  {%>
                    <% if (matches[y] === user[0].id) {%>
                        <%found2 = 1;%>
                <%}}%>
                <%if (found2 === 1) {%>
                    <span><i class="fas fa-heartbeat" style="color: red; font-size: xx-large; margin-left: 10px"></i></span>
            <%}}%>

            <%if (likes !== null && found2 === 0) {%>
                <% for (var z = 0; z < likes.length; z++)  {%>
                    <% if (likes[z].user_id === user[0].id) {%>
                    <%found3 = 1;%>
                <%}}%>
                <%if (found3 === 1) {%>
                    <span><i class="far fa-smile-wink" style="color: rgb(255, 0, 100); font-size: xx-large; margin-left: 10px"></i></span>
            <%}}%>

        </div>
        <h2 class="mt-0" id="userDetails"><%=user[0]['username']%> (<%=user[0]['firstname']%> <%=user[0]['lastname']%>)</h2>

        <div class="row">
            <div class="col-sm" id=genderOrientation>
                <% if (user[0]['gender'] === null) { %>
                    Genre non renseigne,
                <%} else { %>
                <%=user[0]['gender']%>,
                <% } %>
                <% if (user[0]['orientation'] === null) { %>
                    Orientation non renseignee
                <%} else { %>
                <%=user[0]['orientation']%>
                <% } %>
            </div>
        </div>
        <div class="row" id="age">
            <div class="col-sm" id="displayAge">
                <% if (user[0]['birth'] == null) { %>
                    Date de naissance manquante
                <%} else { %>
                    <%= userage %> ans
                <% } %>
            </div>
        </div>
        <div class="row" id="location">
            <div class="col-sm">
                À 7km
            </div>
        </div>
        <div class="description" id="desc">
            <% if (user[0]['description'] == null) { %>
                Description manquante
            <%} else { %>
            <%=user[0]['description']%>
            <% } %>
        </div>

        <div id="tags">
            <% if (usertags != "") {
            for (var i=0; i<usertags.length; i++){ %>
            <a class="btn btn-primary hashtag" href="#" role="button">#<%=usertags[i]['tag']%></a>
            <% }} %>
        </div>
    </div>
</div>
<br>
<div class="row" id="rowPic" style="justify-content: left; margin-left: 4%;">

    <% if (userphotos !== []) {
    for (var j = 0; j < userphotos.length; j++) { %>
    <div class="col-sm">
        <img src="/<%=userphotos[j]['photo']%>" class="img-thumbnail carroussel" alt="...">
    </div>
    <% }} %>

</div>
<div id="issues">

    <%if (reports !== null) {%>
        <% for (var r = 0; r < reports.length; r++)  {%>
            <% if (reports[r].reported_id === user[0].id && reports[r].flag === 1) {%>
            <%found4 = 1;%>
        <%}}%>
        <%if (found4 === 1) {%>
            <p id="fake"><strong>It's a FAKE !</strong> <span><i class="fas fa-thumbs-down" style="font-size: x-large;"></i></span></p>
            <%} else if(found4 === 0) {%>
            <p id="notFake" onclick="reportFake(<%=user[0].id%>)">Reporter comme Faux Compte <span><i class="fas fa-thumbs-down" style="font-size: x-large"></i></span></p>
    <%}}%>

        <%if (reports !== null) {%>
            <% for (var s = 0; s < reports.length; s++)  {%>
                <% if (reports[s].reported_id === user[0].id && reports[s].flag === 2) {%>
                <%found5 = 1;%>
            <%}}%>
            <%if (found5 === 1) {%>
                <p onclick="unBlock(<%=user[0].id%>)">Vous avez bloqué cet utilisateur... <span><i class="fas fa-angry" style="font-size: x-large; color: red"></i></span></p>
            <%} else if(found5 === 0) {%>
                <p onclick="reportBlock(<%=user[0].id%>)">Bloquer cet utilisateur <span><i class="fas fa-angry" style="font-size: x-large"></i></span></p>
        <%}}%>


</div>

<% include ../partial/footer.ejs%>

<script>

    console.log();

    function iLike(userId) {
        const formData = {
            'userId': userId,
            'submit': 'iLiked'
        }

        $.ajax({
            type		: 'POST',
            url         : '/user/' + userId,
            data		: formData,
            dataType	: 'json',
            encode		: true
        })
            .done(function(data) {
                console.log('data like: ', data);
                if (data.flag === '1') {
                    $('.fa-thumbs-up').attr('class', 'fas fa-thumbs-up');
                    $('.fa-thumbs-up').attr('style', 'color: dodgerblue; font-size: xx-large; margin-left: 10px');
                    $('.fa-thumbs-up').attr('onclick', 'iUnlike(<%=user[0].id%>)');
                }
                if (data.getMatches) {
                    for (var i = 0; i < data.getMatches.length; i++) {
                        if (data.getMatches[i] === userId) {
                            $('#likeAndMatch').append('<span><i class="fas fa-heartbeat" style="color: red; font-size: xx-large; margin-left: 10px"></i></span>');
                            if ($('.fa-smile-wink')) {
                                $('.fa-smile-wink').remove();
                            }
                        }
                    }
                }
            });

    }

    function iUnlike(userId) {
        const formData = {
            'userId': userId,
            'submit': 'iUnliked'
        }

        $.ajax({
            type		: 'POST',
            url         : '/user/' + userId,
            data		: formData,
            dataType	: 'json',
            encode		: true
        })
            .done(function(data) {
                console.log('data unlike: ', data);
                if (data.flag === '1') {
                    $('.fa-thumbs-up').attr('class', 'far fa-thumbs-up');
                    $('.fa-thumbs-up').attr('style', 'font-size: xx-large; margin-left: 10px');
                    $('.fa-thumbs-up').attr('onclick', 'iLike(<%=user[0].id%>)');

                    if ($('.fa-heartbeat')) {
                        $('.fa-heartbeat').remove();
                    }
                    for (var a = 0; a < data.theyLikedMe.length; a++){
                        if (data.theyLikedMe && data.theyLikedMe[a].user_id === userId) {
                            $('.fa-thumbs-up').append('<span><i class="far fa-smile-wink" style="color: rgb(255, 0, 100); font-size: xx-large; margin-left: 10px"></i></span>');
                        }
                    }
                }
            });

    }

    function reportFake(userId) {
        const formData = {
            'userId': userId,
            'submit': 'iReport'
        }
        $.ajax({
            type		: 'POST',
            url         : '/user/' + userId,
            data		: formData,
            dataType	: 'json',
            encode		: true
        })
            .done(function(data) {
                if (data && data.flag === 'reported updated') {
                    $('#notFake').remove();
                    const fake = document.createElement('p');
                    fake.innerHTML = '<strong>It\'s a FAKE !</strong> <span><i class="fas fa-thumbs-down" style="font-size: x-large;"></i></span>';
                    fake.style = 'color: red;'
                    $('#issues').prepend(fake);

                    var pop = $('span.badge.badge-light')[0].innerHTML;
                    if (parseInt(pop) >= -50) {
                        $('span.badge.badge-light')[0].innerHTML = parseInt(pop) - 50 + '%';
                    }
                }
            });
    }

</script>